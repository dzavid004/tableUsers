
<?
	if(!defined('ENGINE')) die('No hacking');
?>

<h1>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h1>

<?
	// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
	if(isAdmin()){
		$editUserId = (int) $_GET['id'];
		
		dump($editUserId);
		
		
		if($editUserId){
			// –ó–∞–ø—Ä–æ—Å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–π –∏—â–µ—Ç —Ç–∞–∫–æ–π –∞–π–¥–∏
			$SQL = "SELECT * FROM `table_users` WHERE id = '{$editUserId}' ";
			
			$result = mysqli_query($db, $SQL);
			
			// –ï—Å–ª–∏ —Ç–∞–∫–æ–π ID –µ—Å—Ç—å, —Ç–æ –º–æ–∂–Ω–æ –Ω–∞—á–∏–Ω–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
			if(mysqli_num_rows($result)){
					// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –º–∞—Å—Å–∏–≤–µ 
					$editUserInfo =  mysqli_fetch_assoc($result);                                         
					
					// –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –Ω–∞ –∫–Ω–æ–ø–∫—É, —Ç–æ –Ω–∞—á–∏–Ω–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è 
					if($_SERVER['REQUEST_METHOD'] == 'POST'){
					// –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π, –∫–æ—Ç–æ—Ä—É—é –≤–≤–µ–¥–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ —á–µ–∫ –æ—à–∏–±–æ–∫	
					$userLogin = mysqli_real_escape_string($db, $_POST['login']);
					$userCity = (int)$_POST['CITY'];
					$userStatus = $_POST['userStatus'];
					$trast = ''; 
					
					// –ü—Ä–æ–≤–µ–∫—Ä–∫–∞ –æ—à–∏–±–æ–∫ 
					if(mb_strlen($userLogin) < 4) $trast .= '<li>–î–ª–∏–Ω–∞ –ª–æ–≥–∏–Ω–∞ –º–µ–Ω—å—à–µ 4 —Å–∏–º–≤–æ–ª–æ–≤</li>';
					if(mb_strlen($userLogin) > 32) $trast .= '<li>–î–ª–∏–Ω–∞ –ª–æ–≥–∏–Ω–∞ –±–æ–ª—å—à–µ 32 —Å–∏–º–≤–æ–ª–æ–≤</li>';
					if(empty($userCity)) $trast .= '<li>–ù–µ —É–∫–∞–∑–∞–Ω –≥–æ—Ä–æ–¥</li>';
					
					// –ï—Å–ª–∏ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –≥–∞–ª–æ—á–∫—É –≤ –ø–æ–ª–µ "–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",
					//—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É –∏ –¥–∞—Ç—å –∞–¥–º–∏–Ω–∫—É
					if($userStatus == 'on'){
						$userStatus = 1;
					}else $userStatus = 2;
					
					if($_POST['password']){
						$newPassword = $_POST['password'];
						$changePassword = true;
						
						if(mb_strlen($newPassword) < 4) $trast .= '<li>–î–ª–∏–Ω–∞ –ª–æ–≥–∏–Ω–∞ –º–µ–Ω—å—à–µ 4 —Å–∏–º–≤–æ–ª–æ–≤</li>';
					}
					
					// –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç, –Ω–∞—á–∏–Ω–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ª–æ–≥–∏–Ω–∞
					if(empty($trast)){
						// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è $changeLogin –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –ø—É—Å—Ç–∞—è
						$changeLogin = false;
						// –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–Ω–∞. –ï—Å–ª–∏ –ª–æ–≥–∏–Ω –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Ä–∞–≤–µ–Ω —Ç–æ–º—É, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª,
						// –∑–Ω–∞—á–∏—Ç –µ–≥–æ –Ω–µ —Ç—Ä–æ–≥–∞–ª–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–µ –Ω—É–∂–Ω–æ. 
						// –ê –µ—Å–ª–∏ –æ–Ω –ù–ï —Ä–∞–≤–µ–Ω –µ–º—É, —Ç–æ –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏
						if($userLogin != $editUserInfo['userLogin']){
							
							// –ï—Å–ª–∏ –º—ã –≤—Å—ë —Ç–∞–∫–∏ –Ω–∞—á–∞–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å –ø—Ä–æ–≤–µ—Ä–∫–∏, –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è $changeLogin 
							// —Å—Ç–∞–Ω–æ—á–∏—Ç—Å—è true
							$changeLogin = true;
							// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è $searchNewLoginInTable –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ true
							$searchNewLoginInTable = true;
							// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞ –ª–æ–≥–∏–Ω–∞ 
							$SQL_LOGIN = "SELECT * FROM `table_users` WHERE `userLogin` = '{$userLogin}'";	
							$login_result = mysqli_query($db, $SQL_LOGIN);
							
							// –ï—Å–ª–∏ –ª–æ–≥–∏–Ω –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∏ –Ω–∞ –æ–¥–∏–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —Ç–æ –Ω–∞—á–∏–Ω–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
							if(mysqli_num_rows($login_result) == 0){
								// –ï—Å–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞—à–ª–∏,
								//—Ç–æ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è $searchNewLoginInTable —Å—Ç–∞–Ω–æ—á–∏—Ç—Å—è false
								$searchNewLoginInTable = false; 
							}else{
								echo '–¢–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
							}
						}
						
						// –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ 
						
						if($changePassword){
							$newPassword = getHash($newPassword);

						}
						
						
						// –ó–∞–ø—Ä–æ—Å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏–Ω—Ñ—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
						$UPDATE = "UPDATE `table_users` SET ";
						
						if($changeLogin and $searchNewLoginInTable == false){
							$UPDATE .= "userLogin = '{$userLogin}', ";
						}
						
						if($changePassword){
							$UPDATE .= "userPassword = '{$newPassword}', ";
						}
						
						$UPDATE .= "userCity='{$userCity}',
						userStatus='{$userStatus}'
						WHERE id='{$editUserId}'";
						
						// –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞ –ª–æ–≥–∏–Ω–∞, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
						if($searchNewLoginInTable == false){
							// –î–æ–ª–≥–æ–∂–¥–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö üòç
							$result = mysqli_query($db, $UPDATE);
							
							if($result){
								echo '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ, –¥–µ—Ä–∂–∏ –ø–µ—á–µ–Ω—å–∫—É üç™';
							}else{
								echo '–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –ø–æ–ø—Ä–æ–±—É—Ç–µ –ø–æ–∑–∂–µ';
							}
						}else{
							echo '–û—à–∏–±–∫–∞: –¢–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç';
						}
						
						
					}else{
						echo '<h3>–û—à–∏–±–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: 	</h3>';
						echo '<ul>';
							echo $trast;
						echo '</ul>';
					}
					
				}else{
					
					include 'temp/editUserform.php';
				}
			}else{
				echo '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–∞–∫–∏ ID –Ω–µ—Ç';
			}
		}else{
			echo '–ù–µ —É–∫–∞–∑–∞–Ω ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
		}
	}else{
		echo '–í–∞—Å—è, –≥—É–ª—è–π!';
	}
?>